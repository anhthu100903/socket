<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef1f7;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f4f6f9;
        }

        tr:hover {
            background-color: #e2e6ea;
        }

        .selected {
            background-color: #d1ecf1 !important;
        }

        textarea {
            width: 100%;
            padding: 12px;
            resize: none;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #218838;
        }

        #status {
            margin-top: 20px;
            font-weight: bold;
        }

        .status-success {
            color: green;
        }

        .status-fail {
            color: red;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h2>üõ†Ô∏è B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>

        <div class="client-list">
            <h3>üë• Danh s√°ch client ƒëang k·∫øt n·ªëi:</h3>
            <table id="clientTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Tin nh·∫Øn m·ªõi nh·∫•t</th>
                        <th>Ch·ªçn</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4">-- ƒêang t·∫£i... --</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="message-box">
            <label for="adminMessage">üí¨ N·ªôi dung tin nh·∫Øn:</label>
            <textarea id="adminMessage" rows="4" placeholder="Nh·∫≠p tin nh·∫Øn t·∫°i ƒë√¢y..."></textarea>
            <button id="sendBtn">üì® G·ª≠i ƒë·∫øn client ƒë√£ ch·ªçn</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        const socket = new WebSocket('ws://' + window.location.host + '/ws/admin/');
        let selectedClientId = null;

        socket.onopen = function () {
            console.log("‚úÖ K·∫øt n·ªëi v·ªõi admin WebSocket server.");
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const tableBody = document.querySelector('#clientTable tbody');

            if (data.type === 'clients') {
                tableBody.innerHTML = ''; // Clear current list
                if (data.clients.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4">-- Kh√¥ng c√≥ client n√†o ƒëang k·∫øt n·ªëi --</td></tr>';
                    selectedClientId = null;
                } else {
                    data.clients.forEach(client => {
                        const row = document.createElement('tr');
                        row.dataset.clientId = client.id;
                        row.innerHTML = `
                            <td>${client.id}</td>
                            <td>üü¢ Online</td>
                            <td>${client.lastMessage || '-- Ch∆∞a c√≥ tin nh·∫Øn --'}</td>
                            <td><button onclick="selectClient(${client.id}, this)">Ch·ªçn</button></td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } else if (data.type === 'status') {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = data.message;
                statusDiv.className = data.message.includes("‚úÖ") ? "status-success" : "status-fail";
            } else if (data.type === 'newMessage') {
                // C·∫≠p nh·∫≠t tin nh·∫Øn m·ªõi c·ªßa client
                const clientRow = document.querySelector(`tr[data-client-id="${data.clientId}"]`);
                if (clientRow) {
                    clientRow.cells[2].textContent = data.message;
                }
            }
        };

        function selectClient(clientId, btn) {
            selectedClientId = clientId;
            // Remove previous selections
            document.querySelectorAll('#clientTable tr').forEach(tr => tr.classList.remove('selected'));
            // Highlight selected row
            btn.closest('tr').classList.add('selected');
        }

        document.getElementById('sendBtn').onclick = function () {
            const message = document.getElementById('adminMessage').value;
            if (!selectedClientId) {
                alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt client tr∆∞·ªõc khi g·ª≠i tin nh·∫Øn.");
                return;
            }
            if (message.trim() === '') {
                alert("‚ö†Ô∏è Tin nh·∫Øn kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
                return;
            }

            socket.send(JSON.stringify({
                target_client: selectedClientId,
                message: message
            }));
        };
    </script>
</body>
</html>
